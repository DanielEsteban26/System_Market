<!--
    DashboardWindow.xaml
    Vista principal de dashboard para el sistema de ventas.
    Muestra KPIs, gráficos, listados y accesos rápidos para monitoreo y gestión.
    Utiliza MaterialDesignInXaml y LiveCharts para visualización moderna.
-->

<Window x:Class="System_Market.Views.DashboardWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:services="clr-namespace:System_Market.Services"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:lvc="clr-namespace:LiveChartsCore.SkiaSharpView.WPF;assembly=LiveChartsCore.SkiaSharpView.WPF"
        Title="Dashboard"
        Height="980" Width="1480"
        WindowStartupLocation="CenterOwner"
        Background="#10181F"
        FontFamily="Segoe UI"
        Loaded="Window_Loaded">

    <Window.Resources>
        <!-- Paleta de colores y brushes para el tema oscuro y los paneles -->
        <Color x:Key="ColPanel">#18242C</Color>
        <SolidColorBrush x:Key="BrushPanel" Color="{StaticResource ColPanel}"/>
        <SolidColorBrush x:Key="BrushTextMuted" Color="#9EB6C4"/>
        <SolidColorBrush x:Key="BrushKpiPrimary" Color="#90CAF9"/>
        <SolidColorBrush x:Key="BrushOk" Color="#4CAF50"/>
        <SolidColorBrush x:Key="BrushWarn" Color="#FFC107"/>
        <SolidColorBrush x:Key="BrushErr" Color="#EF5350"/>
        <SolidColorBrush x:Key="BrushBarBack" Color="#22333A"/>
        <SolidColorBrush x:Key="BrushBarFill" Color="#4DA3FF"/>

        <Style TargetType="materialDesign:Card" x:Key="CardBase">
            <Setter Property="Background" Value="{StaticResource BrushPanel}"/>
            <Setter Property="Foreground" Value="#E9F2F8"/>
            <Setter Property="Padding" Value="14"/>
            <Setter Property="Margin" Value="6,8,6,8"/>
            <Setter Property="materialDesign:ShadowAssist.ShadowDepth" Value="Depth1"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>
        <Style x:Key="CardKpi" TargetType="materialDesign:Card" BasedOn="{StaticResource CardBase}">
            <Setter Property="MinHeight" Value="120"/>
            <Setter Property="Padding" Value="18,16,18,14"/>
        </Style>
        <Style x:Key="CardFilter" TargetType="materialDesign:Card" BasedOn="{StaticResource CardBase}">
            <Setter Property="Padding" Value="8,6,10,6"/>
            <Setter Property="Margin" Value="0,0,12,0"/>
            <Setter Property="MinHeight" Value="58"/>
        </Style>

        <Style TargetType="TextBlock" x:Key="KpiTitle">
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Foreground" Value="{StaticResource BrushTextMuted}"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Margin" Value="0,0,0,6"/>
        </Style>
        <Style TargetType="TextBlock" x:Key="KpiValue">
            <Setter Property="FontSize" Value="28"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource BrushKpiPrimary}"/>
        </Style>
        <Style TargetType="TextBlock" x:Key="SectionHeader">
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="#90CAF9"/>
            <Setter Property="Margin" Value="0,0,0,10"/>
        </Style>

        <Style x:Key="BtnBase" TargetType="Button" BasedOn="{StaticResource MaterialDesignRaisedButton}">
            <Setter Property="Foreground" Value="#E5EEF2"/>
            <Setter Property="Background" Value="#22313A"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="Margin" Value="0,0,10,0"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="materialDesign:ShadowAssist.ShadowDepth" Value="Depth1"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border CornerRadius="4" Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Setter Property="Cursor" Value="Hand"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#2E4451"/>
                </Trigger>
                <Trigger Property="IsPressed" Value="True">
                    <Setter Property="Background" Value="#1B2931"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="BtnPrimary" TargetType="Button" BasedOn="{StaticResource BtnBase}">
            <Setter Property="Background" Value="#3F51B5"/>
        </Style>
        <Style x:Key="BtnAccentAlt" TargetType="Button" BasedOn="{StaticResource BtnBase}">
            <Setter Property="Background" Value="#7E57C2"/>
        </Style>
        <Style x:Key="BtnSuccess" TargetType="Button" BasedOn="{StaticResource BtnBase}">
            <Setter Property="Background" Value="#2E7D32"/>
        </Style>

        <Style x:Key="QuickActionButton" TargetType="Button">
            <Setter Property="Foreground" Value="#E6EEF2"/>
            <Setter Property="Background" Value="#2B3942"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Margin" Value="0,0,0,6"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="3">
                            <ContentPresenter Margin="4,0" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#36505E"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style TargetType="ProgressBar" x:Key="MiniProgress">
            <Setter Property="Height" Value="8"/>
            <Setter Property="Foreground" Value="#4DA3FF"/>
            <Setter Property="Background" Value="#22333A"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>

        <Style x:Key="OrdenRowText" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Foreground" Value="#E1ECF2"/>
            <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
        </Style>

        <Style TargetType="DataGrid" x:Key="FlatDataGrid">
            <Setter Property="AutoGenerateColumns" Value="False"/>
            <Setter Property="CanUserAddRows" Value="False"/>
            <Setter Property="HeadersVisibility" Value="Column"/>
            <Setter Property="RowBackground" Value="#1C272E"/>
            <Setter Property="AlternatingRowBackground" Value="#202F37"/>
            <Setter Property="Foreground" Value="#E1ECF2"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="GridLinesVisibility" Value="None"/>
            <Setter Property="RowHeight" Value="32"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="CellStyle">
                <Setter.Value>
                    <Style TargetType="DataGridCell">
                        <Setter Property="BorderThickness" Value="0"/>
                        <Setter Property="Padding" Value="6,0,6,0"/>
                        <Style.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Background" Value="#2F4652"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Setter.Value>
            </Setter>
            <Setter Property="ColumnHeaderStyle">
                <Setter.Value>
                    <Style TargetType="DataGridColumnHeader">
                        <Setter Property="Background" Value="#22313A"/>
                        <Setter Property="Foreground" Value="#9EB6C4"/>
                        <Setter Property="FontSize" Value="12"/>
                        <Setter Property="FontWeight" Value="SemiBold"/>
                        <Setter Property="Padding" Value="6,4"/>
                        <Setter Property="BorderThickness" Value="0,0,0,1"/>
                        <Setter Property="BorderBrush" Value="#1D2A31"/>
                    </Style>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="DeltaBadgeBorder" TargetType="Border">
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Padding" Value="6,2,6,2"/>
            <Setter Property="Margin" Value="0,8,0,0"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
            <Setter Property="Background" Value="#123B27"/>
        </Style>

        <services:CurrencyConverter x:Key="CurrencyConverter"/>
    </Window.Resources>

    <Grid Margin="18,14,18,12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!--
            HEADER: Título y acciones principales
            - Botón Aplicar: Aplica los filtros seleccionados.
            - Botón Refrescar: Recarga los datos del dashboard.
            - Botón Exportar: Exporta los datos mostrados.
        -->
        <DockPanel Grid.Row="0" Margin="0,0,0,14">
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Left" VerticalAlignment="Center">
                <TextBlock Text="Dashboard" FontSize="22" FontWeight="Bold" Foreground="#90CAF9" Margin="0,0,22,0"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" VerticalAlignment="Center">
                <!-- Botones principales -->
                <Button Style="{StaticResource BtnPrimary}" Click="BtnAplicarFiltros_Click" Width="96">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE8FB;" Margin="0,0,6,0"/>
                        <TextBlock Text="Aplicar"/>
                    </StackPanel>
                </Button>
                <Button Style="{StaticResource BtnBase}" Click="BtnRefrescarDashboard_Click" Width="110">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE72C;" Margin="0,0,6,0"/>
                        <TextBlock Text="Refrescar"/>
                    </StackPanel>
                </Button>
                <Button Style="{StaticResource BtnAccentAlt}" Click="BtnExportar_Click" Width="110" PreviewKeyDown="BtnExportar_PreviewKeyDown">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE74E;" Margin="0,0,6,0"/>
                        <TextBlock Text="Exportar"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </DockPanel>

        <!--
            FILTROS: Permiten filtrar la información mostrada en el dashboard.
            - Rango de fechas: presets y personalizado.
            - Categoría: filtra por categoría de producto.
            - Usuario: filtra por usuario.
            - Umbral: define el stock mínimo para alertas.
            - Usuario actual: muestra el usuario logueado.
        -->
        <Grid Grid.Row="1" Margin="0,0,0,4">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="3.4*"/>
                <ColumnDefinition Width="1.6*"/>
                <ColumnDefinition Width="1.6*"/>
                <ColumnDefinition Width="1.0*"/>
                <ColumnDefinition Width="1.2*"/>
            </Grid.ColumnDefinitions>

            <materialDesign:Card Grid.Column="0" Style="{StaticResource CardFilter}" Margin="0,0,12,0">
                <DockPanel>
                    <TextBlock Text="Rango de fechas" DockPanel.Dock="Top" FontSize="11" Foreground="{StaticResource BrushTextMuted}" Margin="0,0,0,4"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="1.4*"/>
                            <ColumnDefinition Width="1*"/>
                            <ColumnDefinition Width="1*"/>
                        </Grid.ColumnDefinitions>
                        <ComboBox x:Name="cbRangoFecha"
                                  Grid.Column="0"
                                  ItemsSource="{Binding RangoFechaPresets}"
                                  DisplayMemberPath="Nombre"
                                  SelectedValuePath="Clave"
                                  SelectionChanged="FiltroRangoFecha_Changed"/>
                        <DatePicker x:Name="dpDesde" Grid.Column="1" SelectedDateChanged="FiltroFecha_Changed"/>
                        <DatePicker x:Name="dpHasta" Grid.Column="2" SelectedDateChanged="FiltroFecha_Changed"/>
                    </Grid>
                </DockPanel>
            </materialDesign:Card>

            <materialDesign:Card Grid.Column="1" Style="{StaticResource CardFilter}" Margin="0,0,12,0">
                <DockPanel>
                    <TextBlock Text="Categoría" DockPanel.Dock="Top" FontSize="11" Foreground="{StaticResource BrushTextMuted}" Margin="0,0,0,4"/>
                    <ComboBox x:Name="cbCategoria" DisplayMemberPath="Nombre" SelectedValuePath="Id" SelectionChanged="FiltroCategoria_Changed"/>
                </DockPanel>
            </materialDesign:Card>

            <materialDesign:Card Grid.Column="2" Style="{StaticResource CardFilter}" Margin="0,0,12,0">
                <DockPanel>
                    <TextBlock Text="Usuarios" DockPanel.Dock="Top" FontSize="11" Foreground="{StaticResource BrushTextMuted}" Margin="0,0,0,4"/>
                    <ComboBox x:Name="cbUsuario" DisplayMemberPath="Nombre" SelectedValuePath="Id" SelectionChanged="FiltroUsuario_Changed"/>
                </DockPanel>
            </materialDesign:Card>

            <materialDesign:Card Grid.Column="3" Style="{StaticResource CardFilter}" Margin="0,0,12,0">
                <DockPanel>
                    <TextBlock Text="Umbral" DockPanel.Dock="Top" FontSize="11" Foreground="{StaticResource BrushTextMuted}" Margin="0,0,0,4" HorizontalAlignment="Center"/>
                    <TextBox x:Name="txtUmbralStock" Width="64" Height="26" Text="5" MaxLength="3"
                             TextAlignment="Center" HorizontalAlignment="Center"
                             VerticalContentAlignment="Center"
                             PreviewTextInput="TxtUmbralStock_PreviewTextInput"/>
                </DockPanel>
            </materialDesign:Card>

            <materialDesign:Card Grid.Column="4" Style="{StaticResource CardFilter}">
                <DockPanel>
                    <TextBlock Text="Usuario" DockPanel.Dock="Top" FontSize="11" Foreground="{StaticResource BrushTextMuted}" Margin="0,0,0,4" HorizontalAlignment="Center"/>
                    <TextBlock x:Name="txtUsuarioActual" FontWeight="SemiBold" Foreground="#90CAF9" HorizontalAlignment="Center"/>
                </DockPanel>
            </materialDesign:Card>
        </Grid>

        <!--
            CONTENIDO PRINCIPAL: KPIs, gráficos y listados
            - KPIs: Ventas, Ganancia neta, Órdenes, Alertas de stock bajo.
            - Gráficos: Evolución de ventas, Distribución por categoría, Ingresos vs Gastos, Heatmap de horas.
            - Listados: Top 10 productos, Stock bajo, Órdenes recientes.
            - Acciones rápidas: accesos directos configurables por el usuario.
        -->
        <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" Margin="0,8,0,0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="3*"/>
                    <ColumnDefinition Width="2.2*"/>
                    <ColumnDefinition Width="2.2*"/>
                    <ColumnDefinition Width="2.2*"/>
                </Grid.ColumnDefinitions>

                <!-- KPIs: Indicadores clave de negocio -->
                <!-- Ventas, Ganancia neta, Órdenes, Alertas de stock bajo -->
                <!-- Cada uno en su CardKpi -->
                <materialDesign:Card Grid.Row="0" Grid.Column="0" Style="{StaticResource CardKpi}">
                    <StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE7F8;" Foreground="#4DA3FF" Margin="0,0,6,0"/>
                            <TextBlock Text="Ventas" Style="{StaticResource KpiTitle}"/>
                        </StackPanel>
                        <TextBlock x:Name="txtVentasRango" Text="S/ 0,00" Style="{StaticResource KpiValue}"/>
                        <Border x:Name="bdDeltaVentas" Style="{StaticResource DeltaBadgeBorder}" Visibility="Collapsed">
                            <TextBlock x:Name="txtVentasDelta" FontSize="11" Foreground="#4CAF50"/>
                        </Border>
                    </StackPanel>
                </materialDesign:Card>

                <materialDesign:Card Grid.Row="0" Grid.Column="1" Style="{StaticResource CardKpi}">
                    <StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE9D2;" Foreground="#4DA3FF" Margin="0,0,6,0"/>
                            <TextBlock Text="Ganancia neta" Style="{StaticResource KpiTitle}"/>
                        </StackPanel>
                        <TextBlock x:Name="txtGananciaNeta" Text="S/ 0,00" Style="{StaticResource KpiValue}"/>
                        <TextBlock x:Name="txtGananciaInfo" FontSize="11" Foreground="{StaticResource BrushTextMuted}" Margin="0,8,0,0"/>
                    </StackPanel>
                </materialDesign:Card>

                <materialDesign:Card Grid.Row="0" Grid.Column="2" Style="{StaticResource CardKpi}">
                    <StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xEC50;" Foreground="#4DA3FF" Margin="0,0,6,0"/>
                            <TextBlock Text="Órdenes" Style="{StaticResource KpiTitle}"/>
                        </StackPanel>
                        <TextBlock x:Name="txtCantidadVentas" Text="0" Style="{StaticResource KpiValue}"/>
                        <ProgressBar x:Name="pbOrdenes" Style="{StaticResource MiniProgress}" Minimum="0" Value="0" Margin="0,10,0,0"/>
                    </StackPanel>
                </materialDesign:Card>

                <materialDesign:Card Grid.Row="0" Grid.Column="3" Style="{StaticResource CardKpi}" MouseLeftButtonUp="CardStockBajo_Click">
                    <StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE7BA;" Foreground="#FFC107" Margin="0,0,6,0"/>
                            <TextBlock Text="Alertas stock" Style="{StaticResource KpiTitle}"/>
                        </StackPanel>
                        <TextBlock x:Name="txtStockBajo" Text="0" Style="{StaticResource KpiValue}"/>
                        <TextBlock x:Name="txtPorcStockBajo" FontSize="11" Margin="0,8,0,0"/>
                    </StackPanel>
                </materialDesign:Card>

                <!-- Gráficos principales -->
                <!-- Evolución de ventas (líneas), Distribución por categoría (torta) -->
                <materialDesign:Card Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" MinHeight="300" Style="{StaticResource CardBase}">
                    <StackPanel>
                        <TextBlock Text="Evolución de ventas" Style="{StaticResource SectionHeader}" Margin="0,0,0,4"/>
                        <lvc:CartesianChart x:Name="chartEvolucionVentas" Height="240"/>
                    </StackPanel>
                </materialDesign:Card>

                <materialDesign:Card Grid.Row="1" Grid.Column="2" Grid.ColumnSpan="2" MinHeight="300" Style="{StaticResource CardBase}">
                    <StackPanel>
                        <TextBlock Text="Distribución por categoría" Style="{StaticResource SectionHeader}" Margin="0,0,0,4"/>
                        <lvc:PieChart x:Name="chartDistribucionVentas" Height="240" LegendPosition="Right"/>
                    </StackPanel>
                </materialDesign:Card>

                <!-- Listados y visualizaciones -->
                <!-- Top 10 productos más vendidos -->
                <!-- Ingresos vs gastos (gráfico y totales) -->
                <!-- Heatmap de horas con más ventas -->
                <!-- Productos con stock bajo -->
                <!-- Órdenes recientes -->
                <materialDesign:Card Grid.Row="2" Grid.Column="0" MinHeight="330" Style="{StaticResource CardBase}">
                    <StackPanel>
                        <TextBlock Text="Top 10 productos" Style="{StaticResource SectionHeader}" Margin="0,0,0,8"/>
                        <Grid Margin="0,0,0,4">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="220"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="Producto" Foreground="{StaticResource BrushTextMuted}" FontSize="12" FontWeight="SemiBold"/>
                            <TextBlock Grid.Column="1" Text="Cantidad" Foreground="{StaticResource BrushTextMuted}" FontSize="12" FontWeight="SemiBold" HorizontalAlignment="Right"/>
                        </Grid>
                        <ScrollViewer Height="250" VerticalScrollBarVisibility="Auto">
                            <ItemsControl x:Name="lvTopVendidos">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="0,2" Height="30">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="220"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="{Binding Nombre}" VerticalAlignment="Center" TextTrimming="CharacterEllipsis"/>
                                            <Grid Grid.Column="1" Margin="10,0,0,0" VerticalAlignment="Center">
                                                <Border Background="{StaticResource BrushBarBack}" CornerRadius="3"/>
                                                <ProgressBar Value="{Binding Cantidad, Mode=OneWay}"
                                                             Maximum="{Binding DataContext.MaxCantidadTop, RelativeSource={RelativeSource AncestorType=ItemsControl}, Mode=OneWay}"
                                                             Foreground="{StaticResource BrushBarFill}"
                                                             Background="{x:Null}"
                                                             BorderThickness="0"
                                                             Height="12"/>
                                                <TextBlock Text="{Binding Cantidad}"
                                                           FontSize="11"
                                                           FontWeight="SemiBold"
                                                           Foreground="White"
                                                           HorizontalAlignment="Right"
                                                           Margin="0,0,4,0"
                                                           VerticalAlignment="Center"/>
                                            </Grid>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </StackPanel>
                </materialDesign:Card>

                <materialDesign:Card Grid.Row="2" Grid.Column="1" MinHeight="330" Style="{StaticResource CardBase}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <TextBlock Text="Ingresos vs. gastos" Style="{StaticResource SectionHeader}" Margin="0,0,0,4"/>
                        <lvc:CartesianChart x:Name="chartIngresosGastos" Grid.Row="1" Height="170" Margin="0,4,0,0" Background="Transparent"/>
                        <UniformGrid Grid.Row="2" Margin="0,18,0,4" Columns="2">
                            <Border Margin="0,0,10,0" Padding="10,6" CornerRadius="6" Background="#152128">
                                <TextBlock x:Name="txtIngresosMonto" Text="S/ 0,00" FontSize="12" FontWeight="SemiBold" Foreground="#4DA3FF" HorizontalAlignment="Center"/>
                            </Border>
                            <Border Margin="10,0,0,0" Padding="10,6" CornerRadius="6" Background="#152128">
                                <TextBlock x:Name="txtGastosMonto" Text="S/ 0,00" FontSize="12" FontWeight="SemiBold" Foreground="#FF8A65" HorizontalAlignment="Center"/>
                            </Border>
                        </UniformGrid>
                    </Grid>
                </materialDesign:Card>

                <materialDesign:Card Grid.Row="2" Grid.Column="2" MinHeight="330" Style="{StaticResource CardBase}">
                    <StackPanel>
                        <TextBlock Text="Horas con más ventas" Style="{StaticResource SectionHeader}" Margin="0,0,0,4"/>
                        <lvc:CartesianChart x:Name="chartHorasVentas" Height="210" Margin="4,6,4,0" Background="Transparent"/>
                        <TextBlock x:Name="txtHorasHint" Text="(Sin datos en rango)" FontSize="11" Foreground="{StaticResource BrushTextMuted}" Margin="0,8,0,0" Visibility="Collapsed"/>
                    </StackPanel>
                </materialDesign:Card>

                <materialDesign:Card Grid.Row="2" Grid.Column="3" MinHeight="330" Style="{StaticResource CardBase}">
                    <DockPanel>
                        <TextBlock Text="Stock bajo" DockPanel.Dock="Top" Style="{StaticResource SectionHeader}" Margin="0,0,0,8"/>
                        <DataGrid x:Name="dgStockBajo" Style="{StaticResource FlatDataGrid}" Height="250" Background="#1C272E">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Producto" Binding="{Binding Nombre}" Width="*"/>
                                <DataGridTextColumn Header="Stock" Binding="{Binding Stock}" Width="70"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </DockPanel>
                </materialDesign:Card>

                <materialDesign:Card Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2" MinHeight="330" Style="{StaticResource CardBase}">
                    <StackPanel>
                        <TextBlock Text="Órdenes recientes" Style="{StaticResource SectionHeader}" Margin="0,0,0,6"/>
                        <Grid Margin="0,0,0,4">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="100"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="120"/>
                                <ColumnDefinition Width="120"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="Fecha" FontWeight="SemiBold" Foreground="{StaticResource BrushTextMuted}" FontSize="12"/>
                            <TextBlock Grid.Column="1" Text="Usuario" FontWeight="SemiBold" Foreground="{StaticResource BrushTextMuted}" FontSize="12"/>
                            <TextBlock Grid.Column="2" Text="Estado" FontWeight="SemiBold" Foreground="{StaticResource BrushTextMuted}" FontSize="12"/>
                            <TextBlock Grid.Column="3" Text="Monto" FontWeight="SemiBold" Foreground="{StaticResource BrushTextMuted}" FontSize="12" HorizontalAlignment="Right"/>
                        </Grid>
                        <ScrollViewer Height="250" VerticalScrollBarVisibility="Auto">
                            <ItemsControl ItemsSource="{Binding OrdenesRecientes}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Height="30" Margin="0,1">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="100"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="120"/>
                                                <ColumnDefinition Width="120"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="{Binding Fecha}" Style="{StaticResource OrdenRowText}"/>
                                            <TextBlock Grid.Column="1" Text="{Binding Cliente}" Style="{StaticResource OrdenRowText}"/>
                                            <TextBlock Grid.Column="2" Text="{Binding Estado}" Style="{StaticResource OrdenRowText}"/>
                                            <TextBlock Grid.Column="3" Text="{Binding MontoStr}" Style="{StaticResource OrdenRowText}" HorizontalAlignment="Right" FontWeight="SemiBold" Foreground="#64B5F6"/>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </StackPanel>
                </materialDesign:Card>

                <!-- Acciones rápidas (ocupa el espacio de los indicadores: columnas 2 y 3) -->
                <materialDesign:Card Grid.Row="3" Grid.Column="2" Grid.ColumnSpan="2" MinHeight="330" Style="{StaticResource CardBase}">
                    <StackPanel>
                        <TextBlock Text="Acciones rápidas" Style="{StaticResource SectionHeader}" Margin="0,0,0,6"/>
                        <ItemsControl x:Name="icQuickActions">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Button Click="QuickAction_Click" Style="{StaticResource QuickActionButton}">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="{Binding Icono}" Margin="0,0,8,0"/>
                                            <TextBlock Text="{Binding Titulo}" VerticalAlignment="Center"/>
                                        </StackPanel>
                                        <Button.ContextMenu>
                                            <ContextMenu>
                                                <MenuItem Header="Quitar" Click="QuickAction_Quitar_Click"/>
                                            </ContextMenu>
                                        </Button.ContextMenu>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <Separator Margin="0,12,0,10" Background="#24323A" Height="1"/>

                        <StackPanel Orientation="Horizontal">
                            <ComboBox x:Name="cbAccion" DisplayMemberPath="Titulo" SelectedValuePath="Clave" Width="260" Margin="0,0,12,0"/>
                            <Button Content="Agregar" Click="BtnAgregarAccion_Click" Style="{StaticResource BtnSuccess}" Padding="18,8" Width="100"/>
                        </StackPanel>
                    </StackPanel>
                </materialDesign:Card>
            </Grid>
        </ScrollViewer>

        <!--
            OVERLAY DE CARGA: Se muestra mientras se cargan los datos.
        -->
        <Grid x:Name="LoadingOverlay" Background="#80000000" Visibility="Collapsed" Grid.RowSpan="3">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Width="260" Height="6"/>
                <TextBlock Text="Cargando..." Foreground="White" FontSize="15" Margin="0,12,0,0"/>
            </StackPanel>
        </Grid>

        <!--
            SNACKBAR: Notificaciones y mensajes informativos.
        -->
        <materialDesign:Snackbar x:Name="MainSnackbar"
                                 Grid.RowSpan="3"
                                 HorizontalAlignment="Right"
                                 VerticalAlignment="Bottom"
                                 Margin="0,0,26,26"/>
    </Grid>
</Window>